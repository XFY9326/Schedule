---
title: '外部课程导入'
---

## 概述

对于某些特殊的情况（例如已经存在本校的App或者打开校园网页需要特殊认证等情况），Pure课程表提供的适配方式可能不能够满足使用条件。  
例如：需要引入大量第三方API或SDK，或者希望能够快速的不需要用户在Pure课程表再次登陆就能够导入课程等。

因此Pure课程表也支持从外部直接传入HTML页面等解析需要的数据与参数，进行课程解析与导入。  

在适配外部课程导入前，请先完成[本地模拟登录课程解析]({{< ref "模拟登录与简单网络请求课程导入" >}})或者[基于浏览器的课程导入]({{< ref "基于浏览器的课程导入" >}})的适配。  
外部课程导入功能仅支持以上两种适配方式的外部导入，并需要完成[课程导入配置]({{< ref "配置与注册课程导入信息" >}})的编写。  
  
如果您不希望该导入方式显示在‘课程导入’列表中，可以不对需要适配的课程导入配置进行注册（即不添加@CourseImportConfig注解）。  
  
**注：外部课程导入功能更多的是对[基于浏览器的课程导入]({{< ref "基于浏览器的课程导入" >}})的补充与拓展**  

## 适配

首先在content.adapters.processor下新建一个类，继承base.AbstractExternalCourseProcessor，实现其中的方法

### AbstractExternalCourseProcessor

``` kotlin
// 泛型参数与继承使用方式如下：  
// T1：你需要使用到的课程提供器类型，例如：XXXCourseProvider
// T2：你需要使用到的课程解析器类型，例如：XXXCourseParser
// C：你需要使用到的课程导入配置，需要满足课程提供器类型与课程解析器类型，例如：XXXImportConfig
// 最后向父类的构造函数传递课程导入配置的KClass对象，例如：XXXImportConfig::class
abstract class AbstractExternalCourseProcessor<T1, T2, C>(KClass<C>)

// 需要实现的方法：
// 将在导入课程时被调用
// data: 外部传入的数据
// provider: 课程提供器
// parser: 课程解析器
// ScheduleImportContent：导入的课程信息，为null代表传入的数据有误导致无法解析
// 在该类中您可以直接调用课程提供器与课程解析器的方法，最终返回解析结果
suspend fun onImportCourse(data: ExternalCourseImportData, provider: T1, parser: T2): ScheduleImportContent?
```

在以上实现的方法中返回的ScheduleImportContent**多数情况并不需要手动生成**  
您可以查看CourseImportHelper类中提供的方法，直接传入课程提供器与课程解析器，就能返回解析结果  
您**只需要专注于处理传入的数据**并调用方法即可

### CourseImportHelper

该类提供了课程导入的帮助

``` kotlin
// 导入在线课程
suspend fun importNetworkCourse(params: NetworkCourseImportParams, importOption: Int, provider: NetworkCourseProvider<*>, parser: NetworkCourseParser<*>): ScheduleImportContent

// 分析网页
// 返回：导入选项，网页分析结果
// 返回null代表网页内容无法解析出结果
fun analyseWebPage(content: WebPageContent, provider: WebCourseProvider<*>): Pair<Int, WebPageContent>?

// 解析网页
fun parseWebCourse(content: WebPageContent, importOption: Int, parser: WebCourseParser<*>): ScheduleImportContent
```

### ExternalCourseImportData

该类中包含外部传入的信息

``` kotlin
// 外部传入的文件的字符串列表
val fileContentList: List<String>

// 外部传入的参数Bundle
val bundle: Bundle?
```

## 注册外部课程导入处理器

和课程导入配置文件一样，外部课程导入处理器需要在被注册后才能成功调用  
即在编写的外部课程处理器的class上，添加注解@ExternalCourseProcessor

``` kotlin
// name: 外部课程导入处理器的注册名称，必须唯一，用于标识与外部调用
@ExternalCourseProcessor(name: String)
```

## 调用

在其他App中使用Intent隐式启动外部课程处理器进行课程导入，Intent要求如下：  

Action: tool.xfy9326.schedule.action.EXTERNAL_COURSE_IMPORT  
Type: text/plain  
Data: 需要解析的HTML或者其他文本文件所在的URI，满足text/plain的MIME即可，详见[传递单个或多个文本文件的URI]({{< ref "#传递单个或多个文本文件的URI" >}})  
ClipData: 如果你需要使用多个URI传递多个文件，则需要通过ClipData的方式传递信息，详见[传递单个或多个文本文件的URI]({{< ref "#传递单个或多个文本文件的URI" >}})  
Extra:
| 名称                 | 类型   | 说明                                                           |
| -------------------- | ------ | -------------------------------------------------------------- |
| PROCESSOR_NAME       | String | 外部课程处理器注册名称，即@ExternalCourseProcessor中的name参数 |
| PROCESSOR_EXTRA_DATA | Bundle | 额外参数（可选）                                               |

Flags: Intent.FLAG_GRANT_READ_URI_PERMISSION  （授予其他APP读取URI的权限）  

当且仅当课程导入成功时，返回RESULT_OK  

注1：之所以使用本地文件URI传递数据，是为了防止传递文件较大导致出错  
注2：您可以把需要解析的文本数据写入App内置存储（例如cache文件夹）后，使用[FileProvider](https://developer.android.com/training/secure-file-sharing/setup-sharing)生成URI传递给Pure课程表  
注3：为了防止未安装Pure课程表导致的错误，建议使用Intent.resolveActivity()方法先进行检测  
注4：安卓高版本可能要求在AndroidManifest中添加<queries>以控制[软件包可见性](https://developer.android.com/training/basics/intents/package-visibility)，请酌情处理

### 传递单个或多个文本文件的URI

一般情况下在Data中填入URI就可以传递单个文件  
如果您需要传递多个文件就需要用到ClipData传递URI，因为这样才能授予Pure课程表多个文件的读写权限  
当设置了Data参数时，只会读取Data参数中的单个URI  
仅限Data参数为null（没有设置）时，才会去读取ClipData中的URI列表，该列表不得为空列表  
请保证至少有一个URI通过Intent传递给Pure课程表  

### 示例

``` kotlin
object PureScheduleApi {
    private const val ACTION_EXTERNAL_COURSE_IMPORT = "tool.xfy9326.schedule.action.EXTERNAL_COURSE_IMPORT"
    private const val EXTRA_PROCESS_NAME = "PROCESSOR_NAME"
    private const val EXTRA_PROCESSOR_EXTRA_DATA = "PROCESSOR_EXTRA_DATA"
    private const val DATA_MIME = "text/plain"

    fun externalCourseImport(context: Context, vararg uri: Uri): Boolean {
        if (uri.isEmpty()) return false
        val intent = Intent(ACTION_EXTERNAL_COURSE_IMPORT).apply {
            if (uri.size == 1) {
                setDataAndType(uri.first(), DATA_MIME)
            } else {
                type = DATA_MIME
                clipData = ClipData.newRawUri(null, uri.first()).also {
                    for (i in 1 until uri.size) {
                        it.addItem(ClipData.Item(uri[i]))
                    }
                }
            }
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
            putExtra(EXTRA_PROCESS_NAME, "NAME")
            putExtra(
                EXTRA_PROCESSOR_EXTRA_DATA, bundleOf(
                    "EXTRA" to 1
                )
            )
        }
        return if (intent.resolveActivity(context.packageManager) == null) {
            false
        } else {
            context.startActivity(intent)
            true
        }
    }
}
```

### 软件包可见性控制

``` xml
<queries>
    <intent>
        <action android:name="tool.xfy9326.schedule.action.EXTERNAL_COURSE_IMPORT" />
        <data android:mimeType="text/plain" />
    </intent>
</queries>
```

### 常见问题

1. 如果提示‘启动参数有缺失’，请注意核对参数是否填写完整
2. 如果提示‘初始化错误’，可能是由于Pure课程表出现问题，请及时上报
3. 如果在导入课程时提示‘课程导入页面错误’，在确认传入数据无误后，有可能是URI读取权限问题。请先尝试在自己的App中读取这个URI的内容。由于安卓版本的原因，可能直接存放在files，cache等文件夹根目录的文件无法读取，建议使用一个文件夹例如cache/html存放文件，然后生成URI。
